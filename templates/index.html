{% extends "base.html" %}

{% block title %}Submit Claim - ReimburseFlow{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0" x-data="claimForm()">
    <!-- Header -->
    <div class="text-center mb-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">Submit Reimbursement Claim</h2>
        <p class="text-gray-600">Upload your bills and fill out the form to submit your reimbursement claim</p>
    </div>

    <!-- Main Form -->
    <form @submit.prevent="submitClaim" class="space-y-8">
        <!-- Employee Details Section -->
        <div class="bg-white custom-shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                <i class="fas fa-user mr-2 text-blue-500"></i>Employee Details
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Employee Name *</label>
                    <input type="text" x-model="formData.employee_name" required readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Department *</label>
                    <input type="text" x-model="formData.department" required readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Head of Department *</label>
                    <input type="text" x-model="formData.hod" required readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">HOD Email *</label>
                    <input type="email" x-model="formData.hod_email" required readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">CC Emails</label>
                    <input type="text" x-model="formData.cc_emails" readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Mode *</label>
                    <select x-model="formData.payment_mode" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select Expense Category</option>
                        <option value="Reimbursement">Reimbursement</option>
                        <option value="Petty Cash">Petty Cash</option>
                        <option value="Happay Cash">Happay Cash</option>
                        <option value="Happay Card">Happay Card</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Expense Transactions Section -->
        <div class="bg-white custom-shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                <i class="fas fa-receipt mr-2 text-green-500"></i>Expense Details
            </h3>
            
            <!-- Transaction Entries -->
            <div class="space-y-6">
                <template x-for="(transaction, index) in transactions" :key="index">
                    <div class="border border-gray-200 rounded-lg p-6">
                        <!-- Transaction Header -->
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-md font-medium text-gray-800" x-text="`Transaction ${index + 1}`"></h4>
                            <button type="button" @click="removeTransaction(index)" x-show="transactions.length > 1"
                                    class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                Remove
                            </button>
                        </div>

                        <!-- Bill Upload -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Invoice/Bill *</label>
                            <div class="file-drop-zone rounded-lg p-4 text-center cursor-pointer border-2 border-dashed border-gray-300 hover:border-blue-400 transition-colors"
                                 @dragover.prevent="$el.classList.add('dragover')"
                                 @dragleave.prevent="$el.classList.remove('dragover')"
                                 @drop.prevent="handleFileDrop($event, index)"
                                 @click="document.getElementById(`fileInput${index}`).click()">
                                <div x-show="!transaction.bill_file">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-600 font-medium">Choose File or drag here</p>
                                    <p class="text-xs text-gray-500">Supports: Any file format (Images, PDFs, Documents) - Max 16MB</p>
                                </div>
                                <div x-show="transaction.bill_file" class="flex items-center justify-center space-x-2">
                                    <i class="text-green-500 text-lg" 
                                       :class="transaction.bill_file?.type === 'application/pdf' ? 'fas fa-file-pdf' : 'fas fa-file-image'"></i>
                                    <span x-text="transaction.bill_file?.name" class="text-sm text-gray-700 font-medium"></span>
                                    <span x-text="transaction.bill_file ? `(${(transaction.bill_file.size / (1024 * 1024)).toFixed(2)} MB)` : ''" class="text-xs text-gray-500"></span>
                                    <button type="button" @click.stop="removeBillFile(index)" class="ml-2 text-red-500 hover:text-red-700 text-lg">
                                        <i class="fas fa-times-circle"></i>
                                    </button>
                                </div>
                                <input type="file" :id="`fileInput${index}`" @change="handleFileSelect($event, index)" 
                                       accept="*" class="hidden">
                            </div>
                            
                            <!-- Processing Indicator -->
                            <div x-show="transaction.processing" class="mt-2 text-center">
                                <div class="inline-flex items-center text-blue-600">
                                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                                    <span x-text="transaction.bill_file?.type === 'application/pdf' ? 'Processing PDF with AI...' : 'Processing image with AI...'"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Expense Details Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Row 1 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bill Date *</label>
                                <input type="date" x-model="transaction.bill_date" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bill No *</label>
                                <input type="text" x-model="transaction.bill_number" required placeholder="Bill No"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Transaction Category *</label>
                                <select x-model="transaction.transaction_category" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select Transaction Category</option>
                                    <option value="Food">Food</option>
                                    <option value="Travel">Travel</option>
                                    <option value="Accommodation">Accommodation</option>
                                    <option value="Others">Others</option>
                                    <option value="Fuel">Fuel</option>
                                    <option value="Forex">Forex</option>
                                </select>
                            </div>

                            <!-- Row 2 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Purpose *</label>
                                <input type="text" x-model="transaction.purpose" required placeholder="Purpose"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount *</label>
                                <input type="number" x-model="transaction.amount" required placeholder="Amount" step="0.01"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Product *</label>
                                <select x-model="transaction.product" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select Product</option>
                                    <option value="Academy Online">Academy Online</option>
                                    <option value="Academy College Plus">Academy College Plus</option>
                                    <option value="Intensive Online">Intensive Online</option>
                                    <option value="Intensive College Plus">Intensive College Plus</option>
                                    <option value="NIAT Asset (Batch 1 & 2)">NIAT Asset (Batch 1 & 2)</option>
                                    <option value="NIAT Asset (Batch 3)">NIAT Asset (Batch 3)</option>
                                    <option value="NIAT Asset Lite (Batch 3)">NIAT Asset Lite (Batch 3)</option>
                                    <option value="NIAT Application">NIAT Application</option>
                                    <option value="NIAT DS Transport">NIAT DS Transport</option>
                                    <option value="NxtWave Abroad Service">NxtWave Abroad Service</option>
                                    <option value="NxtWave Abroad Commission">NxtWave Abroad Commission</option>
                                    <option value="Topin.tech">Topin.tech</option>
                                    <option value="Common">Common</option>
                                </select>
                            </div>

                            <!-- Row 3 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cluster *</label>
                                <select x-model="transaction.cluster" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select Location</option>
                                    <option value="Hyderabad Brigade Towers">Hyderabad Brigade Towers</option>
                                    <option value="Hyderabad Kapil Kavuri Hub">Hyderabad Kapil Kavuri Hub</option>
                                    <option value="All Others Locations">All Others Locations</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Remarks (Optional)</label>
                                <textarea x-model="transaction.remarks" rows="3" placeholder="Remarks (Optional)"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Add Another Transaction Button -->
            <div class="mt-6 text-center">
                <button type="button" @click="addTransaction()" 
                        class="bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Add Another Transaction
                </button>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="text-center">
            <button type="submit" :disabled="isSubmitting"
                    class="bg-green-600 text-white px-8 py-3 rounded-md font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
                <span x-show="!isSubmitting">Submit</span>
                <span x-show="isSubmitting" class="flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                    Processing...
                </span>
            </button>
        </div>
    </form>

    <!-- Success/Results Modal -->
    <div x-show="showResults" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-medium text-gray-900">Claim Submitted Successfully!</h3>
                <button @click="showResults = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div x-show="processedClaim" class="space-y-4">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <span class="text-green-800 font-medium">Claim ID: <span x-text="processedClaim?.claim_id"></span></span>
                    </div>
                </div>
                
                <div class="border-t pt-4">
                    <h4 class="font-medium text-gray-900 mb-2">Claim Summary:</h4>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p><strong>Total Amount:</strong> ₹<span x-text="processedClaim?.total_amount"></span></p>
                        <p><strong>Transactions:</strong> <span x-text="processedClaim?.transaction_count"></span></p>
                        <p><strong>Status:</strong> Pending Approval</p>
                    </div>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button @click="showResults = false; window.location.reload()" 
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Submit Another Claim
                    </button>
                    <a href="/claims" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        View All Claims
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function claimForm() {
    return {
        formData: {
            employee_name: '{% if employee_details %}{{ employee_details.employee_name }}{% endif %}',
            department: '{% if employee_details %}{{ employee_details.department }}{% endif %}',
            hod: '{% if employee_details %}{{ employee_details.hod_name }}{% endif %}',
            hod_email: '{% if employee_details %}{{ employee_details.hod_email }}{% endif %}',
            cc_emails: '{% if employee_details %}{% if employee_details.reporting_2_email %}{{ employee_details.reporting_2_email }}{% endif %}{% if employee_details.reporting_3_email %}{% if employee_details.reporting_2_email %},{% endif %}{{ employee_details.reporting_3_email }}{% endif %}{% endif %}',
            payment_mode: 'Reimbursement'
        },
        transactions: [
            {
                bill_file: null,
                bill_date: '',
                bill_number: '',
                transaction_category: '',
                purpose: '',
                amount: '',
                product: '',
                cluster: '',
                remarks: '',
                processing: false
            }
        ],
        isSubmitting: false,
        showResults: false,
        processedClaim: null,

        addTransaction() {
            this.transactions.push({
                bill_file: null,
                bill_date: '',
                bill_number: '',
                transaction_category: '',
                purpose: '',
                amount: '',
                product: '',
                cluster: '',
                remarks: '',
                processing: false
            });
        },

        removeTransaction(index) {
            if (this.transactions.length > 1) {
                this.transactions.splice(index, 1);
            }
        },

        async handleFileSelect(event, transactionIndex) {
            const file = event.target.files[0];
            if (file) {
                await this.processBill(file, transactionIndex);
            }
        },

        async handleFileDrop(event, transactionIndex) {
            event.target.classList.remove('dragover');
            const file = event.dataTransfer.files[0];
            if (file) {
                await this.processBill(file, transactionIndex);
            }
        },

        async processBill(file, transactionIndex) {
            if (!file) return;

            // Validate file type
            const validTypes = [
                'image/png', 
                'image/jpeg', 
                'image/jpg', 
                'image/webp', 
                'application/pdf'
            ];
            
            if (!validTypes.includes(file.type)) {
                this.showError(`Invalid file type: ${file.type}. Please upload PNG, JPG, JPEG, WEBP, or PDF files.`);
                return;
            }

            // Validate file size (16MB limit)
            if (file.size > 16 * 1024 * 1024) {
                this.showError(`File size (${(file.size / (1024 * 1024)).toFixed(2)} MB) exceeds the 16MB limit.`);
                return;
            }

            // Set the file and start processing
            this.transactions[transactionIndex].bill_file = file;
            this.transactions[transactionIndex].processing = true;

            // Show different messages for different file types
            const isPDF = file.type === 'application/pdf';
            const processingMessage = isPDF ? 'Processing PDF with AI...' : 'Processing image with AI...';

            try {
                const formData = new FormData();
                formData.append('bill_image', file);

                const response = await fetch('/process-bill', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success && data.bill_details) {
                    const transaction = this.transactions[transactionIndex];
                    const details = data.bill_details;

                    // Check if any meaningful data was extracted
                    const hasData = details.amount > 0 || details.bill_number || details.vendor_name;
                    
                    // Auto-fill the form fields with extracted data
                    if (details.bill_date) transaction.bill_date = details.bill_date;
                    if (details.bill_number) transaction.bill_number = details.bill_number;
                    if (details.transaction_category) transaction.transaction_category = details.transaction_category;
                    if (details.purpose) transaction.purpose = details.purpose;
                    if (details.amount) transaction.amount = details.amount;
                    if (details.product) transaction.product = details.product;
                    if (details.cluster_location) transaction.cluster = details.cluster_location;

                    if (hasData) {
                        this.showSuccess(`${isPDF ? 'PDF' : 'Image'} processed successfully! Form fields have been auto-filled.`);
                    } else {
                        this.showWarning(`${isPDF ? 'PDF' : 'Image'} uploaded but no data could be extracted. Please fill the form manually.`);
                    }
                    console.log('Bill processed successfully:', details);
                } else {
                    this.showError(data.error || `Failed to process ${isPDF ? 'PDF' : 'image'}. Please try again.`);
                    console.error('Failed to process bill:', data.error);
                }
            } catch (error) {
                this.showError('Network error while processing bill. Please check your connection and try again.');
                console.error('Error processing bill:', error);
            } finally {
                this.transactions[transactionIndex].processing = false;
            }
        },

        removeBillFile(transactionIndex) {
            const transaction = this.transactions[transactionIndex];
            transaction.bill_file = null;
            
            // Clear auto-filled data
            transaction.bill_date = '';
            transaction.bill_number = '';
            transaction.transaction_category = '';
            transaction.purpose = '';
            transaction.amount = '';
            transaction.product = '';
            transaction.cluster = '';
        },

        showError(message) {
            // Create and show error notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-md';
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        },

        showSuccess(message) {
            // Create and show success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-md';
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        },

        showWarning(message) {
            // Create and show warning notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-yellow-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-md';
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 4000);
        },

        async submitClaim() {
            this.isSubmitting = true;

            try {
                const formData = new FormData();
                
                // Add employee details
                Object.keys(this.formData).forEach(key => {
                    formData.append(key, this.formData[key]);
                });

                // Add transactions
                this.transactions.forEach((transaction, index) => {
                    Object.keys(transaction).forEach(key => {
                        if (key === 'bill_file' && transaction[key]) {
                            formData.append(`transaction_${index}_bill`, transaction[key]);
                        } else if (key !== 'bill_file' && key !== 'processing') {
                            formData.append(`transaction_${index}_${key}`, transaction[key]);
                        }
                    });
                });

                formData.append('transaction_count', this.transactions.length);

                const response = await fetch('/submit-claim', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    this.processedClaim = result.data;
                    this.showResults = true;
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Submission error:', error);
                alert('An error occurred while submitting the claim');
            } finally {
                this.isSubmitting = false;
            }
        }
    };
}
</script>

<style>
[x-cloak] { display: none !important; }

.file-drop-zone.dragover {
    border-color: #667eea;
    background-color: #f7fafc;
}
</style>
{% endblock %}
